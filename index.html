<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Electric & Water Bill Calculator</title>
  <style>
    body { font-family: Arial, sans-serif; background:#fff; margin:0; padding:0; }
    header { background:#000; color:#fff; text-align:center; padding:15px; font-size:1.2em; }
    .container { max-width:720px; margin:18px auto; padding:12px; }
    input, select, button { width:100%; padding:10px; margin:8px 0; font-size:1rem; border:1px solid #000; border-radius:6px; box-sizing:border-box; }
    button { background:#000; color:#fff; cursor:pointer; }
    button:hover { background:#333; }
    .room { border:1px solid #000; border-radius:6px; padding:12px; margin-top:12px; display:flex; flex-direction:column; gap:8px; }
    .room h3 { margin:0; font-size:1.05em; }
    .result { font-weight:700; }
    .totals { font-size:1.1em; text-align:center; margin-top:12px; padding:10px; border-top:2px solid #000; }
    table { border-collapse:collapse; width:100%; font-size:14px; background:#fff; white-space:nowrap; }
    th, td { border:1px solid #000; padding:8px; text-align:center; }
    th { background:#000; color:#fff; }
    .modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20; align-items:center; justify-content:center; }
    .modal-content { background:#fff; padding:18px; border-radius:10px; width:90%; max-width:360px; text-align:center; }
    .modal-buttons { display:flex; gap:10px; margin-top:12px; }
    .btn-yes { flex:1; background:#000; color:#fff; border:none; padding:10px; border-radius:6px; }
    .btn-no { flex:1; background:#ccc; border:none; padding:10px; border-radius:6px; }
  </style>
</head>
<body>
  <header>Electric & Water Bill Calculator</header>

  <div class="container">
    <label>Price per kWh (â‚±):</label>
    <input type="number" id="price" placeholder="Enter price per kWh" oninput="calculate()" min="0" step="0.01">

    <label>Water Bill (â‚±):</label>
    <input type="number" id="waterBill" placeholder="Enter water bill" oninput="calculate()" min="0" step="0.01">

    <label>Select Month:</label>
    <select id="month">
      <option>January</option><option>February</option><option>March</option><option>April</option>
      <option>May</option><option>June</option><option>July</option><option>August</option>
      <option>September</option><option>October</option><option>November</option><option>December</option>
    </select>

    <label>Enter Year:</label>
    <input type="number" id="year" value="2025" min="1900" max="9999">

    <label>Select Rooms (hold CTRL or SHIFT for multiple):</label>
    <select id="roomSelector" multiple size="6">
      <script>
        for (let i = 1; i <= 20; i++) document.write(`<option value="${i}">Room ${i}</option>`);
      </script>
    </select>

    <button onclick="addRoom()">+ Add Selected Rooms</button>

    <div id="rooms"></div>

    <div class="totals">
      <div>Electric Total: â‚±<span id="grandElectric">0.00</span></div>
      <div>Total Water Bill: <span id="grandWater">N/A</span></div>
      <div>Shared Water Bill (per tenant): <span id="sharedWater">N/A</span></div>
      <div style="margin-top:6px;">Combined Total (Electric + Water): â‚±<span id="grandCombined">0.00</span></div>
    </div>

    <div style="margin-top:12px;">
      <button onclick="showModal()">ðŸ“· Download Table as Image</button>
    </div>

    <div id="resultTable" style="margin-top:15px; display:none;"></div>
  </div>

  <!-- Modal -->
  <div class="modal" id="confirmModal">
    <div class="modal-content">
      <p>Download the generated table as an image?</p>
      <div class="modal-buttons">
        <button class="btn-yes" onclick="downloadTableImage()">Yes</button>
        <button class="btn-no" onclick="closeModal()">No</button>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script>
    let selectedRooms = [];

    function addRoom(){
      const selector = document.getElementById("roomSelector");
      const selectedValues = Array.from(selector.selectedOptions).map(o => o.value);
      if (selectedValues.length === 0) {
        alert("Please select at least one room!");
        return;
      }
      const roomsDiv = document.getElementById("rooms");
      selectedValues.forEach(val => {
        if (!selectedRooms.includes(val)) {
          selectedRooms.push(val);
          const roomDiv = document.createElement("div");
          roomDiv.className = "room";
          roomDiv.id = "room" + val;
          roomDiv.innerHTML = `
            <h3>Room ${val}</h3>
            <label>Last Meter Reading:</label>
            <input type="number" id="last${val}" placeholder="Last reading" oninput="calculate()" min="0" step="0.01">
            <label>Current Meter Reading:</label>
            <input type="number" id="current${val}" placeholder="Current reading" oninput="calculate()" min="0" step="0.01">
            <label>Number of Tenants:</label>
            <input type="number" id="tenants${val}" placeholder="Tenants count" oninput="calculate()" min="0" step="1">
            <div class="result">Electric Cost: â‚±<span id="cost${val}">0.00</span></div>
            <div class="result">Shared Water Bill (per tenant): <span id="waterShare${val}">N/A</span></div>
          `;
          roomsDiv.appendChild(roomDiv);
        }
      });
      calculate();
    }

    function calculate(){
      const price = parseFloat(document.getElementById("price").value) || 0;
      const waterBill = parseFloat(document.getElementById("waterBill").value) || 0;

      // total tenants across all rooms
      let totalTenants = 0;
      for (const r of selectedRooms) {
        totalTenants += parseInt(document.getElementById("tenants" + r)?.value) || 0;
      }

      const sharedWaterBill = (waterBill > 0 && totalTenants > 0) ? (waterBill / totalTenants) : NaN;

      let grandElectric = 0;

      for (const r of selectedRooms) {
        const last = parseFloat(document.getElementById("last" + r)?.value) || 0;
        const current = parseFloat(document.getElementById("current" + r)?.value) || 0;
        let diff = current - last;
        if (!Number.isFinite(diff) || diff < 0) diff = 0;
        const cost = diff * price;
        document.getElementById("cost" + r).textContent = cost.toFixed(2);
        grandElectric += cost;

        if (waterBill > 0 && totalTenants > 0 && Number.isFinite(sharedWaterBill)) {
          document.getElementById("waterShare" + r).textContent = "â‚±" + sharedWaterBill.toFixed(2);
        } else {
          document.getElementById("waterShare" + r).textContent = "N/A";
        }
      }

      document.getElementById("grandElectric").textContent = grandElectric.toFixed(2);
      document.getElementById("grandWater").textContent = waterBill > 0 ? "â‚±" + waterBill.toFixed(2) : "N/A";
      document.getElementById("sharedWater").textContent = (waterBill > 0 && totalTenants > 0) ? "â‚±" + sharedWaterBill.toFixed(2) : "N/A";
      const combined = grandElectric + (waterBill > 0 ? waterBill : 0);
      document.getElementById("grandCombined").textContent = combined.toFixed(2);
    }

    function generateTableHTML(){
      const price = parseFloat(document.getElementById("price").value) || 0;
      const waterBill = parseFloat(document.getElementById("waterBill").value) || 0;
      const month = document.getElementById("month").value;
      const year = document.getElementById("year").value;

      let totalTenants = 0;
      for (const r of selectedRooms) totalTenants += parseInt(document.getElementById("tenants" + r)?.value) || 0;

      const sharedWaterBill = (waterBill > 0 && totalTenants > 0) ? (waterBill / totalTenants) : NaN;

      let totalElectric = 0;

      let html = '';
      html += `<h2 style="text-align:center; margin:0;">Tolentino Boarding House</h2>`;
      html += `<h3 style="text-align:center; margin:6px 0 12px 0;">Month: ${month} ${year}</h3>`;
      html += `<table>
        <tr>
          <th>Room</th>
          <th>Last Meter</th>
          <th>Current Meter</th>
          <th>Consumed (kWh)</th>
          <th>kWh Rate</th>
          <th>Tenants</th>
          <th>Electric Bill</th>
          <th>Shared Water Bill (per tenant)</th>
        </tr>`;

      for (const r of selectedRooms) {
        const last = parseFloat(document.getElementById("last" + r)?.value) || 0;
        const current = parseFloat(document.getElementById("current" + r)?.value) || 0;
        let diff = current - last;
        if (!Number.isFinite(diff) || diff < 0) diff = 0;
        const tenants = parseInt(document.getElementById("tenants" + r)?.value) || 0;
        const electricCost = diff * price;
        totalElectric += electricCost;

        let waterDisplay = "N/A";
        if (waterBill > 0 && totalTenants > 0 && Number.isFinite(sharedWaterBill)) {
          waterDisplay = "â‚±" + sharedWaterBill.toFixed(2);
        }

        html += `<tr>
          <td>${r}</td>
          <td>${last}</td>
          <td>${current}</td>
          <td>${diff}</td>
          <td>â‚±${price.toFixed(2)}</td>
          <td>${tenants}</td>
          <td>â‚±${electricCost.toFixed(2)}</td>
          <td>${waterDisplay}</td>
        </tr>`;
      }

      const combinedTotal = totalElectric + (waterBill > 0 ? waterBill : 0);

      html += `<tr>
          <th colspan="6" style="text-align:right">Overall Electric Total:</th>
          <th>â‚±${totalElectric.toFixed(2)}</th>
          <th></th>
        </tr>
        <tr>
          <th colspan="6" style="text-align:right">Total Water Bill:</th>
          <th colspan="2">${waterBill > 0 ? "â‚±" + waterBill.toFixed(2) : "N/A"}</th>
        </tr>
        <tr>
          <th colspan="6" style="text-align:right">Shared Water Bill (per tenant):</th>
          <th colspan="2">${(waterBill > 0 && totalTenants > 0) ? "â‚±" + sharedWaterBill.toFixed(2) : "N/A"}</th>
        </tr>
        <tr>
          <th colspan="6" style="text-align:right">Combined Total (Electric + Water):</th>
          <th colspan="2">â‚±${combinedTotal.toFixed(2)}</th>
        </tr>
      </table>`;

      document.getElementById("resultTable").innerHTML = html;
      document.getElementById("resultTable").style.display = "block";
    }

    function showModal(){
      generateTableHTML();
      document.getElementById("confirmModal").style.display = "flex";
    }
    function closeModal(){ document.getElementById("confirmModal").style.display = "none"; }

    function downloadTableImage(){
      closeModal();
      const table = document.getElementById("resultTable");
      table.style.display = "block";
      const wrapper = document.createElement("div");
      wrapper.style.display = "inline-block";
      wrapper.style.background = "#fff";
      wrapper.style.padding = "18px";
      wrapper.appendChild(table.cloneNode(true));
      document.body.appendChild(wrapper);

      html2canvas(wrapper, { scale:2, backgroundColor:"#ffffff" }).then(canvas => {
        const link = document.createElement("a");
        link.download = 'tolentino_billing_table.png';
        link.href = canvas.toDataURL("image/png");
        link.click();
        wrapper.remove();
        table.style.display = "none";
      });
    }
  </script>
</body>
</html>
